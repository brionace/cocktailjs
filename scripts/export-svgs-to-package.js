const fs = require("fs-extra");
const path = require("path");

const repoRoot = path.resolve(__dirname, "..");
const srcSvgs = path.join(repoRoot, "public", "svgs");
const pkgDist = path.join(repoRoot, "packages", "cocktail-ui", "dist");
const destSvgs = path.join(pkgDist, "svgs");
const assetsMapFile = path.join(pkgDist, "assets-map.js");

function die(msg) {
  console.error(msg);
  process.exit(1);
}

function build() {
  if (!fs.existsSync(srcSvgs)) die(`No source svgs found at ${srcSvgs}`);

  // ensure clean dist
  fs.removeSync(destSvgs);
  fs.ensureDirSync(destSvgs);
  fs.ensureDirSync(pkgDist);

  const map = {};

  // recursively copy and inline
  const walker = (dir, relBase = "") => {
    for (const name of fs.readdirSync(dir)) {
      const srcPath = path.join(dir, name);
      const relPath = relBase ? `${relBase}/${name}` : name;
      const destPath = path.join(destSvgs, relPath);
      const st = fs.statSync(srcPath);
      if (st.isDirectory()) {
        fs.ensureDirSync(destPath);
        walker(srcPath, relPath);
      } else if (name.endsWith(".svg")) {
        fs.copyFileSync(srcPath, destPath);
        const key = path
          .join(path.dirname(relPath), path.basename(name, ".svg"))
          .replace(/\\/g, "/")
          .replace(/^\//, "");
        const svgText = fs.readFileSync(destPath, "utf8");
        map[key] = svgText;
      }
    }
  };

  walker(srcSvgs);

  const content = `// Auto-generated by scripts/export-svgs-to-package.js\nmodule.exports = ${JSON.stringify(
    map,
    null,
    2
  )};\n`;
  fs.writeFileSync(assetsMapFile, content, "utf8");

  console.log("Exported", Object.keys(map).length, "svgs ->", destSvgs);
  console.log("Wrote assets map ->", assetsMapFile);
}

if (require.main === module) build();
